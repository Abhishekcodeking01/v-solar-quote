<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solar Quote Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --card-soft: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.2);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f87171;
      --primary: #22c55e;
      --primary-soft: #bbf7d0;
      --blue-soft: #dbeafe;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(135deg, var(--card-soft), var(--card));
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 30px 70px rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.25);
    }

    h1 {
      margin-top: 0;
      font-size: 28px;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span.logo-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: radial-gradient(circle, #4ade80, #16a34a);
      box-shadow: 0 0 20px rgba(34,197,94,0.9);
    }

    .brand-sub {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .brand-chip {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .subtitle {
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin-top: 18px;
    }

    .card {
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      padding: 16px 16px 18px;
      border: 1px solid rgba(148,163,184,0.2);
      box-shadow: 0 10px 30px rgba(15,23,42,0.8);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-tag {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: rgba(15,23,42,1);
    }

    input[readonly] {
      background: rgba(15,23,42,0.7);
      color: var(--muted);
    }

    .inline-fields {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }

    .inline-fields-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }

    .note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
    }

    .badge-ok {
      color: #4ade80;
      font-size: 11px;
    }

    .badge-warn {
      color: #facc15;
      font-size: 11px;
    }

    .summary-bar {
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(15,23,42,0.95);
      border: 1px dashed rgba(148,163,184,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    .summary-bar strong {
      color: var(--accent);
      font-size: 15px;
    }

    .summary-items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .btn-row {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: transform 0.12s, box-shadow 0.12s, background 0.12s, opacity 0.12s;
    }

    button.primary {
      background: var(--accent);
      color: #022c22;
      box-shadow: 0 10px 25px rgba(34,197,94,0.35);
    }

    button.secondary {
      background: rgba(15,23,42,0.9);
      color: var(--text);
      border: 1px solid rgba(148,163,184,0.6);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(15,23,42,0.85);
      opacity: 0.95;
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.9;
    }

    @media (max-width: 900px) {
      body {
        padding: 12px;
      }
      .grid {
        grid-template-columns: repeat(1, minmax(0,1fr));
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
      <div>
        <h1>
          <span class="logo-dot"></span>
          Solar Quote Generator
        </h1>
        <div class="brand-sub">
          <span>Brand: <strong>V-Sustain Solar Solutions</strong></span>
          <span class="brand-chip">Authorized Luminous Partner</span>
        </div>
        <div class="subtitle">
          Enter plant details, choose components and generate professional quotations with GST in one click.
        </div>
      </div>
      <div style="text-align:right; font-size:12px; color:var(--muted);">
        <div style="font-weight:600;">V-Sustain Solar Solutions</div>
        <div>vsustainsolarsolutions@gmail.com</div>
        <div>üìû +91 99-000-00476</div>
      </div>
    </div>

    <!-- Top controls -->
    <div class="grid" style="margin-top: 22px;">
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">1. Project Size</div>
          <div class="card-tag">kW input</div>
        </div>
        <label for="plantKw">Plant capacity (kW)</label>
        <input type="number" id="plantKw" min="0" step="0.1" placeholder="e.g. 3, 5, 10" />
        <div class="note">
          All auto-calculations (inverter options, panels, installation & structure) use this value.
        </div>
      </div>

      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">2. Margin</div>
          <div class="card-tag">Dealer + %</div>
        </div>
        <label for="marginPercent">Margin over dealer price (%)</label>
        <input type="number" id="marginPercent" min="0" max="200" step="1" value="20" />
        <div class="note">
          Applied on inverters, panels, ACDB, DCDB and other dealer-priced items. GST is added on top.
        </div>
      </div>

      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">Project Info</div>
          <div class="card-tag">Optional</div>
        </div>
        <label for="projectName">Project / Customer name</label>
        <input type="text" id="projectName" placeholder="e.g. Mr. Sharma - 5kW Rooftop" />
        <div class="inline-fields-2" style="margin-top: 8px;">
          <div>
            <label for="projectLocation">Location</label>
            <input type="text" id="projectLocation" placeholder="e.g. Bengaluru, India" />
          </div>
          <div>
            <label for="projectDate">Quotation date</label>
            <input type="date" id="projectDate" />
          </div>
        </div>
      </div>
    </div>

    <!-- Components -->
    <div class="grid">
      <!-- Inverter -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">3. Inverter</div>
          <div class="card-tag">On-grid</div>
        </div>
        <label for="inverterSelect">Inverter model (capacity ‚â• plant kW)</label>
        <select id="inverterSelect">
          <option value="">Select inverter</option>
        </select>
        <div class="inline-fields-2" style="margin-top: 8px;">
          <div>
            <label>Dealer price (‚Çπ)</label>
            <input type="text" id="inverterDealer" readonly />
          </div>
          <div>
            <label>Billing price (excl. GST, with margin)</label>
            <input type="text" id="inverterSell" readonly />
          </div>
        </div>
        <div class="note">GST on inverter: <strong>5%</strong> extra.</div>
      </div>

      <!-- Panels -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">4. Solar Panels</div>
          <div class="card-tag">DC side</div>
        </div>
        <label for="panelSelect">Panel model</label>
        <select id="panelSelect">
          <option value="">Select panel</option>
        </select>

        <div class="inline-fields">
          <div>
            <label>Panel wattage (Wp)</label>
            <input type="text" id="panelWatt" readonly />
          </div>
          <div>
            <label>No. of panels (auto)</label>
            <input type="text" id="panelQty" readonly />
          </div>
          <div>
            <label>Total DC capacity (kWp)</label>
            <input type="text" id="panelCapacity" readonly />
          </div>
        </div>

        <div class="inline-fields-2" style="margin-top:8px;">
          <div>
            <label>Dealer price per panel (‚Çπ)</label>
            <input type="text" id="panelDealer" readonly />
          </div>
          <div>
            <label>Billing price per panel (excl. GST)</label>
            <input type="text" id="panelSell" readonly />
          </div>
        </div>

        <div id="panelCapacityNote" class="note"></div>
        <div class="note">GST on panels: <strong>5%</strong> extra.</div>
      </div>

      <!-- Meter -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">5. Bi-directional Meter</div>
          <div class="card-tag">DISCOM</div>
        </div>
        <label for="meterType">Meter type</label>
        <select id="meterType">
          <option value="">Select</option>
          <option value="Single Phase">Single phase</option>
          <option value="Three Phase">Three phase</option>
        </select>
        <div class="inline-fields-2" style="margin-top: 8px;">
          <div>
            <label>Quantity</label>
            <input type="number" id="meterQty" min="0" step="1" value="1" />
          </div>
          <div>
            <label>Price per unit (‚Çπ, excl. GST)</label>
            <input type="number" id="meterPrice" min="0" step="1" placeholder="Enter price" />
          </div>
        </div>
        <div class="note">GST on meter: <strong>18%</strong> extra.</div>
      </div>
    </div>

    <div class="grid">
      <!-- ACDB -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">6. ACDB</div>
          <div class="card-tag">Protection</div>
        </div>
        <label for="acdbSelect">ACDB model</label>
        <select id="acdbSelect">
          <option value="">Select ACDB</option>
        </select>
        <div class="inline-fields-2" style="margin-top: 8px;">
          <div>
            <label>Quantity</label>
            <input type="number" id="acdbQty" value="1" min="0" step="1" />
          </div>
          <div>
            <label>Billing price per unit (excl. GST)</label>
            <input type="text" id="acdbSell" readonly />
          </div>
        </div>
        <div class="note">GST on ACDB: <strong>18%</strong> extra.</div>
      </div>

      <!-- DCDB -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">7. DCDB</div>
          <div class="card-tag">Protection</div>
        </div>
        <label for="dcdbSelect">DCDB model</label>
        <select id="dcdbSelect">
          <option value="">Select DCDB</option>
        </select>
        <div class="inline-fields-2" style="margin-top: 8px;">
          <div>
            <label>Quantity</label>
            <input type="number" id="dcdbQty" value="1" min="0" step="1" />
          </div>
          <div>
            <label>Billing price per unit (excl. GST)</label>
            <input type="text" id="dcdbSell" readonly />
          </div>
        </div>
        <div class="note">GST on DCDB: <strong>18%</strong> extra.</div>
      </div>

      <!-- AC Cable -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">8. AC Cable</div>
          <div class="card-tag">Manual</div>
        </div>
        <div class="inline-fields">
          <div>
            <label>Gauge / spec</label>
            <input type="text" id="acCableGauge" placeholder="e.g. 4 core 10 sqmm" />
          </div>
          <div>
            <label>Quantity (mtr)</label>
            <input type="number" id="acCableQty" min="0" step="1" />
          </div>
          <div>
            <label>Rate per unit (‚Çπ, excl. GST)</label>
            <input type="number" id="acCablePrice" min="0" step="1" />
          </div>
        </div>
        <div class="note">GST on AC cable: <strong>18%</strong> extra.</div>
      </div>
    </div>

    <div class="grid">
      <!-- Earthing cable -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">9. Earthing Cable</div>
          <div class="card-tag">Manual</div>
        </div>
        <div class="inline-fields">
          <div>
            <label>Gauge / spec</label>
            <input type="text" id="earthCableGauge" placeholder="e.g. 16 sqmm" />
          </div>
          <div>
            <label>Quantity (mtr)</label>
            <input type="number" id="earthCableQty" min="0" step="1" />
          </div>
          <div>
            <label>Rate per unit (‚Çπ, excl. GST)</label>
            <input type="number" id="earthCablePrice" min="0" step="1" />
          </div>
        </div>
        <div class="note">GST on earthing cable: <strong>18%</strong> extra.</div>
      </div>

      <!-- Installation -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">10. Installation</div>
          <div class="card-tag">Auto</div>
        </div>
        <div class="inline-fields-2">
          <div>
            <label>Rate (‚Çπ/kW, excl. GST)</label>
            <input type="number" id="installRate" value="5000" />
          </div>
          <div>
            <label>Installation total (excl. GST)</label>
            <input type="text" id="installTotal" readonly />
          </div>
        </div>
        <div class="note">
          Calculated as <strong>kW √ó rate</strong>. GST on installation: <strong>18%</strong>.
        </div>
      </div>

      <!-- Structure -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">11. Structure</div>
          <div class="card-tag">Auto</div>
        </div>
        <div class="inline-fields-2">
          <div>
            <label>Rate (‚Çπ/kW, excl. GST)</label>
            <input type="number" id="structureRate" value="8000" />
          </div>
          <div>
            <label>Structure total (excl. GST)</label>
            <input type="text" id="structureTotal" readonly />
          </div>
        </div>
        <div class="note">
          Calculated as <strong>kW √ó rate</strong>. GST on structure: <strong>18%</strong>.
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Earthing set -->
      <div class="card" style="grid-column: span 4;">
        <div class="card-header">
          <div class="card-title">12. Earthing Set</div>
          <div class="card-tag">Manual</div>
        </div>
        <div class="inline-fields-2">
          <div>
            <label>Quantity</label>
            <input type="number" id="earthingSetQty" min="0" step="1" value="3" />
          </div>
          <div>
            <label>Price per set (‚Çπ, excl. GST)</label>
            <input type="number" id="earthingSetPrice" min="0" step="1" />
          </div>
        </div>
        <div class="note">GST on earthing set: <strong>18%</strong> extra.</div>
      </div>
    </div>

    <!-- Summary + buttons -->
    <div class="summary-bar">
      <div>
        Project total (incl. GST): <strong id="summaryTotal">‚Çπ0</strong>
      </div>
      <div class="summary-items">
        <span id="summaryPlant">Plant: ‚Äì</span>
        <span id="summaryPanels">Panels: ‚Äì</span>
        <span id="summaryInverter">Inverter: ‚Äì</span>
      </div>
    </div>

    <div class="btn-row">
      <button type="button" class="primary" id="btnDetailed">
        üíº Generate detailed quotation
      </button>
      <button type="button" class="secondary" id="btnSummary">
        üìÑ Generate summary quotation
      </button>
    </div>
  </div>

  <script>
    // ---------- DATA SETUP ----------

    const inverters = [
      { model: "NXI 120(2KW) (EXC.DONGLE)", capacityKw: 2, dealerPrice: 16882 },
      { model: "NXI 130(3KW) (EXC.DONGLE)", capacityKw: 3, dealerPrice: 17915 },
      { model: "NXI 130(3KW) (INCL.DONGLE)", capacityKw: 3, dealerPrice: 18022 },
      { model: "NXI T130(3KW) + DONGLE", capacityKw: 3, dealerPrice: 18022 },
      { model: "NXI 140(4KW) (EXC.DONGLE)", capacityKw: 4, dealerPrice: 28509 },
      { model: "NXI 150(5KW) (EXC.DONGLE)", capacityKw: 5, dealerPrice: 30508 },
      { model: "NXI 305(5KW) (EXC.DONGLE)", capacityKw: 5, dealerPrice: 45696 },
      { model: "NXI 306(6KW) (EXC.DONGLE)", capacityKw: 6, dealerPrice: 51206 },
      { model: "NXI 308(8KW) (EXC.DONGLE)", capacityKw: 8, dealerPrice: 57641 },
      { model: "NXI 310(10KW) (EXC.DONGLE)", capacityKw: 10, dealerPrice: 59110 },
      { model: "NXI 312(12KW) (EXC.DONGLE)", capacityKw: 12, dealerPrice: 63560 },
      { model: "NXI 315(15KW) (EXC.DONGLE)", capacityKw: 15, dealerPrice: 66339 },
      { model: "NXI 320(20KW) (EXC.DONGLE)", capacityKw: 20, dealerPrice: 79429 },
      { model: "NXI 325(25KW) (EXC.DONGLE)", capacityKw: 25, dealerPrice: 97180 },
      { model: "NXI 330(30KW) (EXC.DONGLE)", capacityKw: 30, dealerPrice: 110076 },
      { model: "NXI 350(50KW) (EXC.DONGLE)", capacityKw: 50, dealerPrice: 150912 },
      { model: "NXI 360(60KW) (EXC.DONGLE)", capacityKw: 60, dealerPrice: 161198 },
      { model: "NXI 380(80KW) (EXC.DONGLE)", capacityKw: 80, dealerPrice: 251588 },
      { model: "NXI 3100(100KW) (EXC.DONGLE)", capacityKw: 100, dealerPrice: 268801 },
      { model: "NXI W3125(125KW) (INCL.DONGLE)", capacityKw: 125, dealerPrice: 317042 },
      { model: "NXI W3150(150KW) (INCL.DONGLE)", capacityKw: 150, dealerPrice: 344553 },
      { model: "NXI A3250-HV(250KW)", capacityKw: 250, dealerPrice: 417806 },
      { model: "NXI A3250-HV(350KW)", capacityKw: 350, dealerPrice: 555492 }
    ];

    // Mock solar panels based on common wattages, with Bangalore-ish market prices
    // 550Wp actual (dealer) price provided by you: ‚Çπ1800
    const panels = [
      { name: "Mono PERC 440Wp (Half-Cut)", watt: 440, dealerPrice: 1500 },
      { name: "Mono PERC 500Wp", watt: 500, dealerPrice: 1650 },
      { name: "Mono PERC 540Wp", watt: 540, dealerPrice: 1750 },
      { name: "Mono PERC 550Wp (Bifacial)", watt: 550, dealerPrice: 1800 }
    ];

    // ACDB & DCDB dealer price list (‚Çπ inc tax in sheet, treated as dealer price ex-GST for margin)
    const acdbItems = [
      { sku: "TSAD0AC32PH1", desc: "ACDB Single Phase 32 Amp (0-5 kW)", dealerPrice: 1899.80 },
      { sku: "TSAD0AC63PH1", desc: "ACDB Single Phase 63 Amp (7 kW)", dealerPrice: 2312.80 },
      { sku: "TSAD0AC40PH1", desc: "ACDB Single Phase 40 Amp (9 kW)", dealerPrice: 2277.40 },
      { sku: "TSAD0AC80PH1", desc: "ACDB Single Phase 80 Amp (11 kW)", dealerPrice: 4708.20 },
      { sku: "TSADAC100PH1", desc: "ACDB Single Phase 100 Amp", dealerPrice: 4920.60 },
      { sku: "TSAD0AC32PH3", desc: "ACDB Three Phase 32 Amp", dealerPrice: 4177.20 }
    ];

    const dcdbItems = [
      { sku: "TSADDC600V11", desc: "DCDB 1 In 1 Out With MCB", dealerPrice: 1939.92 },
      { sku: "TSADDC600V22", desc: "DCDB 2 In 2 Out With Fuse", dealerPrice: 2808.40 },
      { sku: "TSADDC600V21", desc: "DCDB 2 In 1 Out With MCB", dealerPrice: 2997.20 },
      { sku: "TSADDC600V31", desc: "DCDB 3 In 1 Out With MCB", dealerPrice: 3835.00 },
      { sku: "TSADDC600V41", desc: "DCDB 4 In 1 Out With MCB", dealerPrice: 4224.40 },
      { sku: "TSADDC600V11F", desc: "DCDB 1 In 1 Out With Fuse (A)", dealerPrice: 1711.00 },
      { sku: "TSADC600V21F", desc: "DCDB 2 In 1 Out With Fuse", dealerPrice: 2383.60 },
      { sku: "TSADC600V31F", desc: "DCDB 3 In 1 Out With Fuse", dealerPrice: 2725.80 },
      { sku: "TSADC600V41F", desc: "DCDB 4 In 1 Out With Fuse", dealerPrice: 3103.40 }
    ];

    // ---------- HELPERS ----------

    const formatMoney = (value) => {
      if (isNaN(value) || !isFinite(value)) return "‚Çπ0";
      return value.toLocaleString("en-IN", {
        style: "currency",
        currency: "INR",
        maximumFractionDigits: 2
      });
    };

    const getMarginFactor = () => {
      const marginInput = document.getElementById("marginPercent");
      const m = parseFloat(marginInput.value || "0");
      if (isNaN(m)) return 1;
      return 1 + m / 100;
    };

    const getPlantKw = () => {
      const plantKwInput = document.getElementById("plantKw");
      const kW = parseFloat(plantKwInput.value || "0");
      return isNaN(kW) ? 0 : kW;
    };

    const getGstRateForType = (type) => {
      // 5% for inverter & panels, 18% for rest
      if (type === "inverter" || type === "panel") return 5;
      return 18;
    };

    const recalcInverterOptions = () => {
      const plantKw = getPlantKw();
      const inverterSelect = document.getElementById("inverterSelect");
      const currentValue = inverterSelect.value;
      inverterSelect.innerHTML = '<option value="">Select inverter</option>';

      const eligible = inverters.filter(i => plantKw === 0 || i.capacityKw >= plantKw);
      eligible.forEach((inv) => {
        const opt = document.createElement("option");
        opt.value = inv.model;
        opt.textContent = `${inv.model} (${inv.capacityKw} kW)`;
        inverterSelect.appendChild(opt);
      });

      const stillExists = Array.from(inverterSelect.options).some(o => o.value === currentValue);
      if (stillExists) inverterSelect.value = currentValue;
      recalcInverterPrice();
    };

    const recalcInverterPrice = () => {
      const inverterSelect = document.getElementById("inverterSelect");
      const inverterDealer = document.getElementById("inverterDealer");
      const inverterSell = document.getElementById("inverterSell");
      const selected = inverters.find(i => i.model === inverterSelect.value);
      const marginFactor = getMarginFactor();

      if (!selected) {
        inverterDealer.value = "";
        inverterSell.value = "";
        return;
      }

      inverterDealer.value = Math.round(selected.dealerPrice).toLocaleString("en-IN");
      const sellPrice = selected.dealerPrice * marginFactor;
      inverterSell.value = Math.round(sellPrice).toLocaleString("en-IN");
    };

    const initPanelOptions = () => {
      const panelSelect = document.getElementById("panelSelect");
      panels.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.name;
        opt.textContent = `${p.name} (${p.watt} Wp)`;
        panelSelect.appendChild(opt);
      });
    };

    const recalcPanels = () => {
      const panelSelect = document.getElementById("panelSelect");
      const panelWattEl = document.getElementById("panelWatt");
      const panelQtyEl = document.getElementById("panelQty");
      const panelCapEl = document.getElementById("panelCapacity");
      const panelDealerEl = document.getElementById("panelDealer");
      const panelSellEl = document.getElementById("panelSell");
      const noteEl = document.getElementById("panelCapacityNote");

      const selected = panels.find(p => p.name === panelSelect.value);
      const plantKw = getPlantKw();
      const marginFactor = getMarginFactor();

      if (!selected || plantKw <= 0) {
        panelWattEl.value = "";
        panelQtyEl.value = "";
        panelCapEl.value = "";
        panelDealerEl.value = "";
        panelSellEl.value = "";
        noteEl.innerHTML = "";
        return;
      }

      panelWattEl.value = selected.watt;
      panelDealerEl.value = Math.round(selected.dealerPrice).toLocaleString("en-IN");
      const sellPrice = selected.dealerPrice * marginFactor;
      panelSellEl.value = Math.round(sellPrice).toLocaleString("en-IN");

      const requiredWatt = plantKw * 1000;
      const qty = Math.ceil(requiredWatt / selected.watt);
      const totalWatt = qty * selected.watt;
      const totalKw = totalWatt / 1000;

      panelQtyEl.value = qty;
      panelCapEl.value = totalKw.toFixed(2);

      const maxKw = plantKw * 1.1;
      if (totalKw <= maxKw) {
        noteEl.innerHTML = `<span class="badge-ok">‚úî Within 10% limit.</span> Panel DC capacity ‚âà ${totalKw.toFixed(2)} kWp (max allowed ${maxKw.toFixed(2)} kWp).`;
      } else {
        noteEl.innerHTML = `<span class="badge-warn">‚ö† Above 10% limit.</span> Panel DC capacity ‚âà ${totalKw.toFixed(2)} kWp (max allowed ${maxKw.toFixed(2)} kWp).`;
      }
    };

    const initAcdbDcdbOptions = () => {
      const acdbSelect = document.getElementById("acdbSelect");
      const dcdbSelect = document.getElementById("dcdbSelect");

      acdbItems.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.sku;
        opt.textContent = `${item.desc} (${item.sku})`;
        acdbSelect.appendChild(opt);
      });

      dcdbItems.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.sku;
        opt.textContent = `${item.desc} (${item.sku})`;
        dcdbSelect.appendChild(opt);
      });
    };

    const recalcAcdbPrice = () => {
      const acdbSelect = document.getElementById("acdbSelect");
      const acdbSell = document.getElementById("acdbSell");
      const marginFactor = getMarginFactor();
      const selected = acdbItems.find(i => i.sku === acdbSelect.value);
      if (!selected) {
        acdbSell.value = "";
        return;
      }
      const sell = selected.dealerPrice * marginFactor;
      acdbSell.value = Math.round(sell).toLocaleString("en-IN");
    };

    const recalcDcdbPrice = () => {
      const dcdbSelect = document.getElementById("dcdbSelect");
      const dcdbSell = document.getElementById("dcdbSell");
      const marginFactor = getMarginFactor();
      const selected = dcdbItems.find(i => i.sku === dcdbSelect.value);
      if (!selected) {
        dcdbSell.value = "";
        return;
      }
      const sell = selected.dealerPrice * marginFactor;
      dcdbSell.value = Math.round(sell).toLocaleString("en-IN");
    };

    const recalcInstallAndStructure = () => {
      const plantKw = getPlantKw();
      const installRate = parseFloat(document.getElementById("installRate").value || "0");
      const structureRate = parseFloat(document.getElementById("structureRate").value || "0");

      document.getElementById("installTotal").value =
        Math.round(plantKw * installRate).toLocaleString("en-IN");
      document.getElementById("structureTotal").value =
        Math.round(plantKw * structureRate).toLocaleString("en-IN");
    };

    const parseIndianNumber = (s) => {
      if (!s) return 0;
      const clean = String(s).replace(/,/g, "").trim();
      const val = parseFloat(clean);
      return isNaN(val) ? 0 : val;
    };

    // Build line items for quotations and totals
    const buildLineItems = () => {
      const items = [];
      const marginFactor = getMarginFactor();
      const plantKw = getPlantKw();

      // Panels
      const panelSel = document.getElementById("panelSelect");
      const panel = panels.find(p => p.name === panelSel.value);
      const panelQty = parseFloat(document.getElementById("panelQty").value || "0");
      const panelCapKw = parseFloat(document.getElementById("panelCapacity").value || "0");

      if (panel && panelQty > 0) {
        const baseRate = panel.dealerPrice * marginFactor;
        items.push({
          type: "panel",
          item: "Solar PV Modules",
          desc: `${panelQty} √ó ${panel.name} (${panel.watt} Wp) | DC capacity ‚âà ${panelCapKw.toFixed(2)} kWp`,
          qty: panelQty,
          unit: "Nos",
          baseRate,
          gstPercent: getGstRateForType("panel")
        });
      }

      // Inverter
      const inverterSel = document.getElementById("inverterSelect");
      const inv = inverters.find(i => i.model === inverterSel.value);
      if (inv) {
        const baseRate = inv.dealerPrice * marginFactor;
        items.push({
          type: "inverter",
          item: "Solar Inverter",
          desc: `${inv.model} (${inv.capacityKw} kW)`,
          qty: 1,
          unit: "Nos",
          baseRate,
          gstPercent: getGstRateForType("inverter")
        });
      }

      // ACDB
      const acdbSel = document.getElementById("acdbSelect");
      const acdbQty = parseFloat(document.getElementById("acdbQty").value || "0");
      const acdbItem = acdbItems.find(i => i.sku === acdbSel.value);
      if (acdbItem && acdbQty > 0) {
        const baseRate = acdbItem.dealerPrice * marginFactor;
        items.push({
          type: "acdb",
          item: "ACDB",
          desc: `${acdbItem.desc} (${acdbItem.sku})`,
          qty: acdbQty,
          unit: "Nos",
          baseRate,
          gstPercent: getGstRateForType("acdb")
        });
      }

      // DCDB
      const dcdbSel = document.getElementById("dcdbSelect");
      const dcdbQty = parseFloat(document.getElementById("dcdbQty").value || "0");
      const dcdbItem = dcdbItems.find(i => i.sku === dcdbSel.value);
      if (dcdbItem && dcdbQty > 0) {
        const baseRate = dcdbItem.dealerPrice * marginFactor;
        items.push({
          type: "dcdb",
          item: "DCDB",
          desc: `${dcdbItem.desc} (${dcdbItem.sku})`,
          qty: dcdbQty,
          unit: "Nos",
          baseRate,
          gstPercent: getGstRateForType("dcdb")
        });
      }

      // Meter
      const meterType = document.getElementById("meterType").value || "";
      const meterQty = parseFloat(document.getElementById("meterQty").value || "0");
      const meterPrice = parseFloat(document.getElementById("meterPrice").value || "0");
      if (meterType && meterQty > 0 && meterPrice > 0) {
        items.push({
          type: "meter",
          item: "Bi-directional Energy Meter",
          desc: meterType,
          qty: meterQty,
          unit: "Nos",
          baseRate: meterPrice,
          gstPercent: getGstRateForType("meter")
        });
      }

      // AC cable
      const acCableGauge = document.getElementById("acCableGauge").value || "";
      const acCableQty = parseFloat(document.getElementById("acCableQty").value || "0");
      const acCablePrice = parseFloat(document.getElementById("acCablePrice").value || "0");
      if (acCableQty > 0 && acCablePrice > 0) {
        items.push({
          type: "acCable",
          item: "AC Cable",
          desc: acCableGauge || "AC Cable",
          qty: acCableQty,
          unit: "Mtr",
          baseRate: acCablePrice,
          gstPercent: getGstRateForType("acCable")
        });
      }

      // Earthing cable
      const earthCableGauge = document.getElementById("earthCableGauge").value || "";
      const earthCableQty = parseFloat(document.getElementById("earthCableQty").value || "0");
      const earthCablePrice = parseFloat(document.getElementById("earthCablePrice").value || "0");
      if (earthCableQty > 0 && earthCablePrice > 0) {
        items.push({
          type: "earthCable",
          item: "Earthing Cable",
          desc: earthCableGauge || "Earthing Cable",
          qty: earthCableQty,
          unit: "Mtr",
          baseRate: earthCablePrice,
          gstPercent: getGstRateForType("earthCable")
        });
      }

      // Installation
      const installRate = parseFloat(document.getElementById("installRate").value || "0");
      if (plantKw > 0 && installRate > 0) {
        items.push({
          type: "installation",
          item: "Installation & Commissioning",
          desc: `Complete installation @ ${formatMoney(installRate)} per kW`,
          qty: plantKw,
          unit: "kW",
          baseRate: installRate,
          gstPercent: getGstRateForType("installation")
        });
      }

      // Structure
      const structureRate = parseFloat(document.getElementById("structureRate").value || "0");
      if (plantKw > 0 && structureRate > 0) {
        items.push({
          type: "structure",
          item: "Module Mounting Structure",
          desc: `Hot dipped galvanized structure @ ${formatMoney(structureRate)} per kW`,
          qty: plantKw,
          unit: "kW",
          baseRate: structureRate,
          gstPercent: getGstRateForType("structure")
        });
      }

      // Earthing set
      const earthingSetQty = parseFloat(document.getElementById("earthingSetQty").value || "0");
      const earthingSetPrice = parseFloat(document.getElementById("earthingSetPrice").value || "0");
      if (earthingSetQty > 0 && earthingSetPrice > 0) {
        items.push({
          type: "earthingSet",
          item: "Earthing Set",
          desc: "Earthing arrangement as per design (chemical / GI / copper bonded)",
          qty: earthingSetQty,
          unit: "Set",
          baseRate: earthingSetPrice,
          gstPercent: getGstRateForType("earthingSet")
        });
      }

      return items;
    };

    const calcTotals = () => {
      const items = buildLineItems();
      let subtotal = 0;
      let totalGst = 0;

      items.forEach(item => {
        const amount = item.baseRate * item.qty;
        const gstAmt = amount * item.gstPercent / 100;
        subtotal += amount;
        totalGst += gstAmt;
      });

      const grandTotal = subtotal + totalGst;

      // Update summary bar
      document.getElementById("summaryTotal").textContent = formatMoney(grandTotal);

      const plantKw = getPlantKw();
      const panelSelect = document.getElementById("panelSelect");
      const panelQty = document.getElementById("panelQty").value || "";
      const inverterSelect = document.getElementById("inverterSelect");
      const selectedInv = inverters.find(i => i.model === inverterSelect.value);

      document.getElementById("summaryPlant").textContent =
        plantKw > 0 ? `Plant: ${plantKw} kW` : "Plant: ‚Äì";
      document.getElementById("summaryPanels").textContent =
        panelSelect.value ? `Panels: ${panelQty} √ó ${panelSelect.value}` : "Panels: ‚Äì";
      document.getElementById("summaryInverter").textContent =
        selectedInv ? `Inverter: ${selectedInv.model}` : "Inverter: ‚Äì";

      return { items, subtotal, totalGst, grandTotal };
    };

    const validateCore = () => {
      const plantKw = getPlantKw();
      const margin = parseFloat(document.getElementById("marginPercent").value || "0");
      if (!plantKw || plantKw <= 0) {
        alert("Please enter a valid plant capacity in kW.");
        return false;
      }
      if (margin < 0) {
        alert("Margin cannot be negative.");
        return false;
      }
      return true;
    };

    // ---------- COMMON SECTIONS FOR QUOTES ----------

    const buildCommonFooterSections = () => {
      return `
      <div class="footer-sections">

        <section class="block">
          <h2>üîí Warranty Snapshot</h2>
          <div class="warranty-grid">
            <div class="w-card">
              <div class="w-label">PV Modules</div>
              <div class="w-value">30 Years*</div>
            </div>
            <div class="w-card">
              <div class="w-label">Inverter</div>
              <div class="w-value">8 Years*</div>
            </div>
            <div class="w-card">
              <div class="w-label">System</div>
              <div class="w-value">5 Years*</div>
            </div>
          </div>
          <div class="fine-print">
            *Please refer to OEM warranty documents and T&C for full details.  
            *Inverter warranty period depends on the specific make and model.
          </div>
        </section>

        <section class="block">
          <h2>üí∞ Payment Terms</h2>
          <ul class="bullets">
            <li>40% advance along with Purchase Order.</li>
            <li>50% on material delivery at site.</li>
            <li>10% after successful commissioning of the system.</li>
          </ul>
        </section>

        <section class="block">
          <h2>üåû Why Luminous Solar with V-Sustain</h2>
          <div class="why-grid">
            <div class="why-card">
              <div class="why-icon">üß©</div>
              <div class="why-title">Customized Solution</div>
              <div class="why-text">System engineered for your roof, load profile and future expansion.</div>
            </div>
            <div class="why-card">
              <div class="why-icon">üõ†Ô∏è</div>
              <div class="why-title">Minimal Maintenance</div>
              <div class="why-text">Rugged components with low downtime and easy serviceability.</div>
            </div>
            <div class="why-card">
              <div class="why-icon">üõ°Ô∏è</div>
              <div class="why-title">Highest Safety Standards</div>
              <div class="why-text">Proper earthing, protection devices and best-practice installation.</div>
            </div>
            <div class="why-card">
              <div class="why-icon">üèÖ</div>
              <div class="why-title">Quality Products</div>
              <div class="why-text">Genuine Luminous products with proven field performance.</div>
            </div>
            <div class="why-card">
              <div class="why-icon">‚ö°</div>
              <div class="why-title">Quick ROI</div>
              <div class="why-text">Reliable power generation that pays back in a few years.</div>
            </div>
            <div class="why-card">
              <div class="why-icon">‚ôªÔ∏è</div>
              <div class="why-title">Smart & Eco-Friendly</div>
              <div class="why-text">Green energy, better branding and a sustainable future.</div>
            </div>
          </div>
        </section>

        <section class="block">
          <h2>üìú General Terms & Conditions</h2>
          <ul class="bullets">
            <li><strong>Taxes & Duties:</strong> Any change in government policy or new taxes, duties or levies will be to the customer‚Äôs account.</li>
            <li><strong>Validity:</strong> This quotation is valid for 15 days from the date of issue.</li>
            <li><strong>Packing:</strong> Standard packing is included. Non-standard packing, if required, will be charged extra.</li>
            <li><strong>Delivery Period:</strong> As per mutually agreed terms in the accepted Purchase Order, subject to force majeure conditions.</li>
            <li><strong>Exclusions:</strong> The warranty does not cover defects arising from customer-supplied materials, improper installation by third parties, misuse, experiments, or operation not in line with manufacturer‚Äôs manuals and industry practice.</li>
            <li><strong>Cancellation:</strong> Orders once accepted cannot be cancelled without our consent and may attract cancellation charges as per company policy.</li>
            <li><strong>Force Majeure:</strong> Conditions beyond reasonable control (war, strikes, natural calamities, supply disruptions, etc.) may impact delivery schedules.</li>
          </ul>
        </section>

        <section class="block">
          <h2>ü§ù Proposal By</h2>
          <div class="proposal-grid">
            <div>
              <div class="proposal-title">V-Sustain Solar Solutions</div>
              <div class="proposal-sub">Authorized Luminous Partner</div>
              <div class="proposal-line">üìß vsustainsolarsolutions@gmail.com</div>
              <div class="proposal-line">üìû Pravesh Kumar Tiwari ‚Äì +91 99-000-00476</div>
              <div class="proposal-line">üìç NO.33/1, 6th Main, Kanteerava Studio Peenya,<br/>Rajagopalnagar Main Rd, Nandini Layout, Bengaluru, Karnataka 560096</div>
            </div>
            <div>
              <div class="proposal-title">Bank Details</div>
              <div class="proposal-line"><strong>Bank:</strong> BANK OF INDIA (SANJAY NAGAR)</div>
              <div class="proposal-line"><strong>Account No:</strong> 849330150000010</div>
              <div class="proposal-line"><strong>IFSC:</strong> BKID0008493</div>
            </div>
          </div>
        </section>

      </div>
      `;
    };

    // ---------- QUOTATION TEMPLATES ----------

    const buildDetailedQuotationHtml = (totals) => {
      const plantKw = getPlantKw();
      const projectName = document.getElementById("projectName").value || "Solar PV System";
      const projectLocation = document.getElementById("projectLocation").value || "";
      const projectDate = document.getElementById("projectDate").value || "";
      const margin = parseFloat(document.getElementById("marginPercent").value || "0");

      const panelSel = document.getElementById("panelSelect");
      const panel = panels.find(p => p.name === panelSel.value);
      const panelQty = parseFloat(document.getElementById("panelQty").value || "0");
      const panelCapKw = parseFloat(document.getElementById("panelCapacity").value || "0");

      const inverterSel = document.getElementById("inverterSelect");
      const inv = inverters.find(i => i.model === inverterSel.value);

      const rowsHtml = totals.items.map((item, idx) => {
        const amount = item.baseRate * item.qty;
        const gstAmt = amount * item.gstPercent / 100;
        const lineTotal = amount + gstAmt;
        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${item.item}</td>
            <td>${item.desc}</td>
            <td style="text-align:right;">${item.qty.toFixed(2).replace(/\.00$/,"")}</td>
            <td>${item.unit}</td>
            <td style="text-align:right;">${formatMoney(item.baseRate)}</td>
            <td style="text-align:right;">${formatMoney(amount)}</td>
            <td style="text-align:center;">${item.gstPercent}%</td>
            <td style="text-align:right;">${formatMoney(gstAmt)}</td>
            <td style="text-align:right;">${formatMoney(lineTotal)}</td>
          </tr>
        `;
      }).join("");

      return `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Quotation - ${projectName}</title>
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f3f4f6;
    margin: 0;
    padding: 24px;
    color: #0f172a;
  }
  .quote {
    max-width: 960px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 14px;
    padding: 24px 28px;
    box-shadow: 0 10px 40px rgba(15,23,42,0.18);
    position: relative;
  }
  .print-btn {
    position: fixed;
    top: 18px;
    right: 24px;
    padding: 6px 12px;
    border-radius: 999px;
    border: none;
    background: #22c55e;
    color: #022c22;
    font-size: 12px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(34,197,94,0.4);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .print-btn span {
    font-size: 14px;
  }
  @media print {
    .print-btn { display:none; }
    body { background:#ffffff; padding:0; }
    .quote { box-shadow:none; border-radius:0; margin:0; }
  }
  h1 {
    margin: 0 0 4px;
    font-size: 24px;
  }
  .brand-line {
    font-size: 13px;
    color: #6b7280;
  }
  .brand-pill {
    display: inline-block;
    font-size: 11px;
    border-radius: 999px;
    padding: 2px 8px;
    border: 1px solid #22c55e;
    color: #166534;
    background: #dcfce7;
    margin-top: 4px;
  }
  .meta {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 18px;
  }
  .meta span {
    display: inline-block;
    margin-right: 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
    font-size: 12px;
  }
  th, td {
    border: 1px solid #e5e7eb;
    padding: 6px 6px;
    vertical-align: top;
  }
  th {
    background: #f9fafb;
    text-align: left;
  }
  tfoot td {
    font-weight: 600;
  }
  tfoot tr.subtotal-row td {
    border-top: 2px solid #0f172a;
  }
  .totals {
    margin-top: 12px;
    text-align: right;
  }
  .totals strong {
    font-size: 18px;
    color: #16a34a;
  }
  .footer-sections {
    margin-top: 24px;
    border-top: 1px solid #e5e7eb;
    padding-top: 18px;
    font-size: 12px;
    color: #374151;
  }
  .block {
    margin-bottom: 16px;
  }
  .block h2 {
    margin: 0 0 6px;
    font-size: 14px;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .warranty-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .w-card {
    flex: 0 0 120px;
    background: #ecfdf5;
    border-radius: 10px;
    padding: 8px 10px;
    border: 1px solid #bbf7d0;
  }
  .w-label {
    font-size: 11px;
    color: #166534;
  }
  .w-value {
    font-size: 16px;
    font-weight: 600;
    color: #16a34a;
  }
  .fine-print {
    font-size: 11px;
    color: #6b7280;
    margin-top: 6px;
  }
  .bullets {
    margin: 0;
    padding-left: 18px;
  }
  .bullets li {
    margin-bottom: 4px;
  }
  .why-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px,1fr));
    gap: 8px;
  }
  .why-card {
    background: #eff6ff;
    border-radius: 10px;
    padding: 8px 10px;
    border: 1px solid #bfdbfe;
  }
  .why-icon {
    font-size: 16px;
  }
  .why-title {
    font-size: 12px;
    font-weight: 600;
    margin-top: 2px;
  }
  .why-text {
    font-size: 11px;
    color: #4b5563;
    margin-top: 2px;
  }
  .proposal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
    gap: 10px;
  }
  .proposal-title {
    font-weight: 600;
    font-size: 13px;
  }
  .proposal-sub {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 4px;
  }
  .proposal-line {
    font-size: 11px;
    margin-bottom: 2px;
  }
</style>
</head>
<body>
  <button class="print-btn" onclick="window.print()"><span>üì•</span> Download / Print PDF</button>
  <div class="quote">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1>Quotation ‚Äì ${projectName}</h1>
        <div class="brand-line">
          V-Sustain Solar Solutions <span class="brand-pill">Authorized Luminous Partner</span>
        </div>
        <div class="meta">
          <span><strong>Project size:</strong> ${plantKw.toFixed(2)} kW</span>
          ${panel ? `<span><strong>DC Capacity:</strong> ${panelCapKw.toFixed(2)} kWp</span>` : ""}
        </div>
      </div>
      <div style="text-align:right; font-size:12px; color:#6b7280;">
        ${projectLocation ? `<div><strong>Location:</strong> ${projectLocation}</div>` : ""}
        ${projectDate ? `<div><strong>Date:</strong> ${projectDate}</div>` : ""}
        <div><strong>Margin:</strong> ${margin.toFixed(1)} % over dealer</div>
        <div><strong>GST:</strong> 5% on inverter & modules, 18% on others</div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Item</th>
          <th>Description</th>
          <th style="text-align:right;">Qty</th>
          <th>Unit</th>
          <th style="text-align:right;">Rate (‚Çπ)</th>
          <th style="text-align:right;">Amount (‚Çπ)</th>
          <th style="text-align:center;">GST %</th>
          <th style="text-align:right;">GST Amt (‚Çπ)</th>
          <th style="text-align:right;">Line Total (‚Çπ)</th>
        </tr>
      </thead>
      <tbody>
        ${rowsHtml}
      </tbody>
      <tfoot>
        <tr class="subtotal-row">
          <td colspan="6" style="text-align:right;">Subtotal (before GST)</td>
          <td style="text-align:right;">${formatMoney(totals.subtotal)}</td>
          <td colspan="3"></td>
        </tr>
        <tr>
          <td colspan="6" style="text-align:right;">Total GST</td>
          <td style="text-align:right;">${formatMoney(totals.totalGst)}</td>
          <td colspan="3"></td>
        </tr>
        <tr>
          <td colspan="6" style="text-align:right;">Grand Total (incl. GST)</td>
          <td style="text-align:right;">${formatMoney(totals.grandTotal)}</td>
          <td colspan="3"></td>
        </tr>
      </tfoot>
    </table>

    <div class="totals">
      Total contract value (incl. GST): <strong>${formatMoney(totals.grandTotal)}</strong>
    </div>

    ${buildCommonFooterSections()}
  </div>
</body>
</html>
      `;
    };

    const buildSummaryQuotationHtml = (totals) => {
      const plantKw = getPlantKw();
      const projectName = document.getElementById("projectName").value || "Solar PV System";
      const projectLocation = document.getElementById("projectLocation").value || "";
      const projectDate = document.getElementById("projectDate").value || "";

      const panelSel = document.getElementById("panelSelect");
      const panel = panels.find(p => p.name === panelSel.value);
      const panelQty = parseFloat(document.getElementById("panelQty").value || "0");
      const panelCapKw = parseFloat(document.getElementById("panelCapacity").value || "0");

      const inverterSel = document.getElementById("inverterSelect");
      const inv = inverters.find(i => i.model === inverterSel.value);

      const linesHtml = totals.items.map((item, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td>${item.item}</td>
          <td>${item.desc}</td>
          <td style="text-align:right;">${item.qty.toFixed(2).replace(/\.00$/,"")}</td>
          <td>${item.unit}</td>
        </tr>
      `).join("");

      return `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Quotation - ${projectName}</title>
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f9fafb;
    margin: 0;
    padding: 24px;
    color: #0f172a;
  }
  .quote {
    max-width: 760px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 14px;
    padding: 24px 28px;
    box-shadow: 0 10px 36px rgba(15,23,42,0.15);
    position: relative;
  }
  .print-btn {
    position: fixed;
    top: 18px;
    right: 24px;
    padding: 6px 12px;
    border-radius: 999px;
    border: none;
    background: #22c55e;
    color: #022c22;
    font-size: 12px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(34,197,94,0.4);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .print-btn span {
    font-size: 14px;
  }
  @media print {
    .print-btn { display:none; }
    body { background:#ffffff; padding:0; }
    .quote { box-shadow:none; border-radius:0; margin:0; }
  }
  h1 {
    margin: 0 0 4px;
    font-size: 24px;
  }
  .brand-line {
    font-size: 13px;
    color: #6b7280;
  }
  .brand-pill {
    display: inline-block;
    font-size: 11px;
    border-radius: 999px;
    padding: 2px 8px;
    border: 1px solid #0ea5e9;
    color: #0369a1;
    background: #e0f2fe;
    margin-top: 4px;
  }
  .meta {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 18px;
  }
  .meta div {
    margin-bottom: 2px;
  }
  .section-title {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: #6b7280;
    margin-bottom: 6px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 12px;
  }
  th, td {
    border: 1px solid #e5e7eb;
    padding: 6px 6px;
    vertical-align: top;
  }
  th {
    background: #f9fafb;
    text-align: left;
  }
  .total {
    margin-top: 16px;
    padding-top: 10px;
    border-top: 2px solid #0f172a;
    text-align: right;
  }
  .total strong {
    font-size: 18px;
    color: #16a34a;
  }
  .hint {
    margin-top: 6px;
    font-size: 11px;
    color: #6b7280;
  }
  .footer-sections {
    margin-top: 24px;
    border-top: 1px solid #e5e7eb;
    padding-top: 18px;
    font-size: 12px;
    color: #374151;
  }
  .block {
    margin-bottom: 16px;
  }
  .block h2 {
    margin: 0 0 6px;
    font-size: 14px;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .warranty-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .w-card {
    flex: 0 0 120px;
    background: #ecfdf5;
    border-radius: 10px;
    padding: 8px 10px;
    border: 1px solid #bbf7d0;
  }
  .w-label {
    font-size: 11px;
    color: #166534;
  }
  .w-value {
    font-size: 16px;
    font-weight: 600;
    color: #16a34a;
  }
  .fine-print {
    font-size: 11px;
    color: #6b7280;
    margin-top: 6px;
  }
  .bullets {
    margin: 0;
    padding-left: 18px;
  }
  .bullets li {
    margin-bottom: 4px;
  }
  .why-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px,1fr));
    gap: 8px;
  }
  .why-card {
    background: #eff6ff;
    border-radius: 10px;
    padding: 8px 10px;
    border: 1px solid #bfdbfe;
  }
  .why-icon {
    font-size: 16px;
  }
  .why-title {
    font-size: 12px;
    font-weight: 600;
    margin-top: 2px;
  }
  .why-text {
    font-size: 11px;
    color: #4b5563;
    margin-top: 2px;
  }
  .proposal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
    gap: 10px;
  }
  .proposal-title {
    font-weight: 600;
    font-size: 13px;
  }
  .proposal-sub {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 4px;
  }
  .proposal-line {
    font-size: 11px;
    margin-bottom: 2px;
  }
</style>
</head>
<body>
  <button class="print-btn" onclick="window.print()"><span>üì•</span> Download / Print PDF</button>
  <div class="quote">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1>Quotation ‚Äì ${projectName}</h1>
        <div class="brand-line">
          V-Sustain Solar Solutions <span class="brand-pill">Quotation (Summary)</span>
        </div>
        <div class="meta">
          <div><strong>Project size:</strong> ${plantKw.toFixed(2)} kW</div>
          ${panel ? `<div><strong>Panels:</strong> ${panelQty} √ó ${panel.name} (${panelCapKw.toFixed(2)} kWp DC)</div>` : ""}
          ${inv ? `<div><strong>Inverter:</strong> ${inv.model} (${inv.capacityKw} kW)</div>` : ""}
        </div>
      </div>
      <div style="text-align:right; font-size:12px; color:#6b7280;">
        ${projectLocation ? `<div><strong>Location:</strong> ${projectLocation}</div>` : ""}
        ${projectDate ? `<div><strong>Date:</strong> ${projectDate}</div>` : ""}
        <div><strong>GST:</strong> 5% on inverter & modules, 18% on others</div>
      </div>
    </div>

    <div class="section-title">Scope overview & bill of quantities</div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Item</th>
          <th>Description</th>
          <th style="text-align:right;">Qty</th>
          <th>Unit</th>
        </tr>
      </thead>
      <tbody>
        ${linesHtml}
      </tbody>
    </table>

    <div class="total">
      Total project value (incl. GST): <strong>${formatMoney(totals.grandTotal)}</strong>
    </div>
    <div class="hint">
      This is a summary view without item-wise price breakup. A detailed component-wise quotation is also available.
    </div>

    ${buildCommonFooterSections()}
  </div>
</body>
</html>
      `;
    };

    const openInNewWindow = (htmlString) => {
      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(htmlString);
      w.document.close();
    };

    // ---------- EVENT BINDINGS ----------

    window.addEventListener("DOMContentLoaded", () => {
      // Init selects
      recalcInverterOptions();
      initPanelOptions();
      initAcdbDcdbOptions();
      recalcInstallAndStructure();
      calcTotals();

      document.getElementById("plantKw").addEventListener("input", () => {
        recalcInverterOptions();
        recalcPanels();
        recalcInstallAndStructure();
        calcTotals();
      });

      document.getElementById("marginPercent").addEventListener("input", () => {
        recalcInverterPrice();
        recalcAcdbPrice();
        recalcDcdbPrice();
        recalcPanels();
        calcTotals();
      });

      document.getElementById("inverterSelect").addEventListener("change", () => {
        recalcInverterPrice();
        calcTotals();
      });

      document.getElementById("panelSelect").addEventListener("change", () => {
        recalcPanels();
        calcTotals();
      });

      document.getElementById("acdbSelect").addEventListener("change", () => {
        recalcAcdbPrice();
        calcTotals();
      });

      document.getElementById("dcdbSelect").addEventListener("change", () => {
        recalcDcdbPrice();
        calcTotals();
      });

      [
        "acdbQty","dcdbQty","meterQty","meterPrice","acCableQty","acCablePrice",
        "earthCableQty","earthCablePrice","installRate","structureRate",
        "earthingSetQty","earthingSetPrice"
      ].forEach(id => {
        document.getElementById(id).addEventListener("input", () => {
          if (id === "installRate" || id === "structureRate") {
            recalcInstallAndStructure();
          }
          calcTotals();
        });
      });

      document.getElementById("btnDetailed").addEventListener("click", () => {
        if (!validateCore()) return;
        const totals = calcTotals();
        const html = buildDetailedQuotationHtml(totals);
        openInNewWindow(html);
      });

      document.getElementById("btnSummary").addEventListener("click", () => {
        if (!validateCore()) return;
        const totals = calcTotals();
        const html = buildSummaryQuotationHtml(totals);
        openInNewWindow(html);
      });
    });
  </script>
</body>
</html>
